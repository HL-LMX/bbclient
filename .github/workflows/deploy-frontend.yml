name: Deploy BookingBite Frontend

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/**"
      - "public/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/deploy-frontend.yml"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: bookingbite-frontend-prod
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, windows, iis, bookingbite, frontend]
    timeout-minutes: 45
    env:
      # Proxy & corporate CA bundle â€” make npm/node trust the proxy-issued certs
      HTTPS_PROXY: http://proxy.hlag.com:11009
      HTTP_PROXY: http://proxy.hlag.com:11009
      NO_PROXY: 127.0.0.1,localhost,*.hlag.com
      NODE_EXTRA_CA_CERTS: C:\certs\corp-bundle.pem
      REQUESTS_CA_BUNDLE: C:\certs\corp-bundle.pem
      SSL_CERT_FILE: C:\certs\corp-bundle.pem
      # Tell npm explicitly via env (overrides .npmrc)
      NPM_CONFIG_CAFILE: C:\certs\corp-bundle.pem
      NPM_CONFIG_STRICT_SSL: "true"
      NPM_CONFIG_PROXY: http://proxy.hlag.com:11009
      NPM_CONFIG_HTTPS_PROXY: http://proxy.hlag.com:11009
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # CRA 5 is most stable on Node 18
      - name: Setup Node.js (v18) with npm cache
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      # Also write a project .npmrc for good measure (env vars above still win)
      - name: Write project .npmrc (proxy + corporate CA bundle)
        run: |
          @"
          proxy=$env:HTTPS_PROXY
          https-proxy=$env:HTTPS_PROXY
          strict-ssl=true
          cafile=C:\certs\corp-bundle.pem
          registry=https://registry.npmjs.org/
          "@ | Out-File -FilePath "$env:GITHUB_WORKSPACE\.npmrc" -Encoding ascii

      - name: Quick npm TLS sanity
        run: |
          npm config get cafile
          npm ping
          npm view react-scripts version

      # Use a bumped cache namespace to avoid any previously-bad node_modules
      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}\node_modules
          key: node-modules-v4-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            node-modules-v4-${{ runner.os }}-

      # Install with secure settings; if it still fails (rare), retry once with strict-ssl=false
      - name: Install dependencies (secure, with one retry)
        run: |
          $ErrorActionPreference = "Stop"
          function Install-Npm {
            if (Test-Path package-lock.json) {
              npm ci --prefer-offline --no-audit --no-fund
            } else {
              npm install --include=dev --prefer-offline --no-audit --no-fund --legacy-peer-deps
            }
          }
          try {
            Install-Npm
          } catch {
            Write-Warning "npm install failed once. Retrying with strict-ssl=false (temporary workaround)."
            npm config set strict-ssl false
            Install-Npm
            npm config set strict-ssl true
          }

      - name: Save node_modules cache
        if: always()
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}\node_modules
          key: node-modules-v4-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      # Build with API base wired for IIS proxying
      - name: Build React app
        run: |
          $env:CI = "true"
          $env:REACT_APP_API_URL = "/api/"
          # Verify react-scripts is present from the normal install (no ad-hoc fetch)
          if (!(Test-Path ".\node_modules\.bin\react-scripts.cmd")) {
            throw "react-scripts missing from node_modules; install step did not complete correctly."
          }
          npm run build
          if (!(Test-Path "$env:GITHUB_WORKSPACE\build\index.html")) {
            throw "Build failed: build\index.html not found"
          }

      - name: Deploy to IIS site root
        run: |
          C:\deployments\scripts\deploy-frontend.ps1 -BuildDir "$env:GITHUB_WORKSPACE\build"
